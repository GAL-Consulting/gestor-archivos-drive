<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Gestor Documental</title>
<link rel="stylesheet" href="style.css">

<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  h1, h3 { color: #333; }
  select, input { margin: 5px 0; width: 300px; display: block; }
  #viewer { border: 1px solid #ccc; width: 100%; height: 400px; margin-top: 10px; }
  ul { list-style: none; padding-left: 0; }
  li a { cursor: pointer; text-decoration: underline; color: blue; }
</style>
</head>
<body>

<h1>Gestor Documental</h1>

<!-- Botón de login -->
<button id="login" disabled>Login con Google</button>

<!-- Contenido oculto hasta login -->
<div id="contenido" style="display:none;">

  <h3>Carpetas disponibles en Drive</h3>
  <select id="listaCarpetas"></select>

  <h3>Documentos PDF en la carpeta</h3>
  <ul id="listaDocs"></ul>

  <h3>Visor de PDF seleccionado</h3>
  <iframe id="viewer"></iframe>

  <h3>Registrar documento en Google Sheets</h3>
  <label>Archivo seleccionado:</label>
  <input id="archivoSeleccionado" readonly>
  <label>Contraparte:</label>
  <input id="contraparte">
  <label>Categoría:</label>
  <input id="categoria">
  <label>Comentarios:</label>
  <input id="comentarios">
  <button id="guardar">Guardar Registro</button>
</div>

<script>
  const CLIENT_ID = "935035577743-7ds3utl0nsbat33sbt2ervnckcgeceqr.apps.googleusercontent.com"; //"TU_CLIENT_ID.apps.googleusercontent.com"; // Pon tu Client ID
  const SHEET_ID = "1D8QeHDNR2bp8Ylfft-AyGTjyNbk_LLF8b6_LwvqBMqY"; // "TU_SHEET_ID"; // Pon tu Sheet ID

  let tokenClient;
  let gapiInited = false;
  let gisInited = false;

  // Inicializar gapi
  function gapiLoaded() { gapi.load('client', initializeGapiClient); }
  async function initializeGapiClient() {
    await gapi.client.init({
      discoveryDocs: [
        "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest",
        "https://sheets.googleapis.com/$discovery/rest?version=v4"
      ]
    });
    gapiInited = true;
    maybeEnableButtons();
  }

  // Inicializar GIS
  function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: "https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/spreadsheets",
      callback: '', // se define al solicitar token
    });
    gisInited = true;
    maybeEnableButtons();
  }

  function maybeEnableButtons() {
    if (gapiInited && gisInited) {
      document.getElementById("login").disabled = false;
    }
  }

  // Login
  document.getElementById("login").onclick = () => {
    tokenClient.callback = async (resp) => {
      if (resp.error) { console.error(resp); return; }

      gapi.client.setToken({ access_token: resp.access_token });

      // Ocultar botón de login
      document.getElementById("login").style.display = "none";
      // Mostrar contenido
      document.getElementById("contenido").style.display = "block";

      listarCarpetas();
    };
    tokenClient.requestAccessToken({ prompt: 'consent' });
  };

  // Listar carpetas
  function listarCarpetas() {
    gapi.client.drive.files.list({
      q: "mimeType='application/vnd.google-apps.folder' and trashed=false",
      fields: "files(id, name)",
      pageSize: 50
    }).then(response => {
      const select = document.getElementById("listaCarpetas");
      select.innerHTML = "";
      response.result.files.forEach(c => {
        let opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.name;
        select.appendChild(opt);
      });
      if (response.result.files.length > 0) listarArchivos(response.result.files[0].id);
      select.onchange = () => listarArchivos(select.value);
    });
  }

  // Listar PDFs
  function listarArchivos(carpetaId) {
    gapi.client.drive.files.list({
      q: `'${carpetaId}' in parents and mimeType='application/pdf' and trashed=false`,
      fields: "files(id, name, webViewLink)",
      pageSize: 50
    }).then(response => {
      const lista = document.getElementById("listaDocs");
      lista.innerHTML = "";
      if (response.result.files.length > 0) {
        response.result.files.forEach(f => {
          const li = document.createElement("li");
          li.innerHTML = `<a>${f.name}</a>`;
          li.querySelector("a").onclick = () => {
            document.getElementById("archivoSeleccionado").value = f.name;
            document.getElementById("archivoSeleccionado").dataset.fileId = f.id;
            document.getElementById("viewer").src = `https://drive.google.com/file/d/${f.id}/preview`;
          };
          lista.appendChild(li);
        });
      } else {
        lista.innerHTML = "<li>No hay archivos PDF en esta carpeta.</li>";
        document.getElementById("viewer").src = "";
        document.getElementById("archivoSeleccionado").value = "";
      }
    });
  }

  // Guardar en Sheets
  document.getElementById("guardar").addEventListener("click", () => {
    const archivo = document.getElementById("archivoSeleccionado").value;
    const fileId = document.getElementById("archivoSeleccionado").dataset.fileId || "";
    const contraparte = document.getElementById("contraparte").value;
    const categoria = document.getElementById("categoria").value;
    const comentarios = document.getElementById("comentarios").value;

    if (!archivo) { alert("Primero selecciona un archivo."); return; }

    const valores = [
      new Date().toISOString(),
      archivo,
      fileId,
      contraparte,
      categoria,
      comentarios
    ];

    gapi.client.sheets.spreadsheets.values.append({
      spreadsheetId: SHEET_ID,
      range: "A:F",
      valueInputOption: "RAW",
      insertDataOption: "INSERT_ROWS",
      resource: { values: [valores] }
    }).then(() => {
      alert("Registro guardado en Sheets!");
      document.getElementById("archivoSeleccionado").value = "";
      document.getElementById("contraparte").value = "";
      document.getElementById("categoria").value = "";
      document.getElementById("comentarios").value = "";
      document.getElementById("viewer").src = "";
    });
  });

  gapiLoaded();
  gisLoaded();
</script>

</body>
</html>

