<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestor Documental</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1, h3 { color: #333; }
    input, select, button { margin: 5px 0; padding: 5px; }
    ul { list-style: none; padding-left: 0; }
    li a { text-decoration: none; color: blue; cursor: pointer; }
    li a:hover { text-decoration: underline; }
  </style>
  <!-- Librer√≠a Google API -->
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <h1>Gestor Documental</h1>

  <!-- Bot√≥n de login -->
  <button id="login">Login con Google</button>

  <!-- Selector de carpetas -->
  <h3>Carpetas disponibles en Drive</h3>
  <select id="listaCarpetas"></select>

  <!-- Listado de documentos -->
  <h3>Documentos PDF en la carpeta</h3>
  <ul id="listaDocs"></ul>

  <!-- Formulario de registro -->
  <h3>Registrar documento en Google Sheets</h3>
  <label>Archivo seleccionado:</label>
  <input id="archivoSeleccionado" readonly><br>

  <label>Contraparte:</label>
  <input id="contraparte"><br>

  <label>Categor√≠a:</label>
  <input id="categoria"><br>

  <label>Comentarios:</label>
  <input id="comentarios"><br>

  <button id="guardar">Guardar Registro</button>

  <script>
    // üîë CONFIGURACI√ìN
    const CLIENT_ID = "TU_CLIENT_ID.apps.googleusercontent.com";
    const SHEET_ID = "TU_SHEET_ID";
    const SCOPES = "https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/spreadsheets";

    // Inicializar cliente Google API
    function initClient() {
      gapi.client.init({
        clientId: CLIENT_ID,
        discoveryDocs: [
          "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest",
          "https://sheets.googleapis.com/$discovery/rest?version=v4"
        ],
        scope: SCOPES
      }).then(() => {
        document.getElementById("login").onclick = handleAuthClick;
      });
    }

    // Cargar librer√≠a
    gapi.load("client:auth2", initClient);

    // Login con Google
    function handleAuthClick() {
      gapi.auth2.getAuthInstance().signIn().then(() => {
        listarCarpetas();
      });
    }

    // Listar carpetas del usuario
    function listarCarpetas() {
      gapi.client.drive.files.list({
        q: "mimeType='application/vnd.google-apps.folder' and trashed=false",
        fields: "files(id, name)",
        pageSize: 20
      }).then(response => {
        const carpetas = response.result.files;
        const select = document.getElementById("listaCarpetas");
        select.innerHTML = "";
        carpetas.forEach(c => {
          let opt = document.createElement("option");
          opt.value = c.id;
          opt.textContent = c.name;
          select.appendChild(opt);
        });

        if (carpetas.length > 0) {
          listarArchivos(carpetas[0].id);
        }

        // Cuando se cambie de carpeta
        select.onchange = () => {
          listarArchivos(select.value);
        };
      });
    }

    // Listar archivos PDF de la carpeta seleccionada
    function listarArchivos(carpetaId) {
      gapi.client.drive.files.list({
        q: `'${carpetaId}' in parents and mimeType='application/pdf' and trashed=false`,
        fields: "files(id, name, webViewLink)",
        pageSize: 50
      }).then(response => {
        const files = response.result.files;
        const lista = document.getElementById("listaDocs");
        lista.innerHTML = "";
        if (files && files.length > 0) {
          files.forEach(f => {
            const li = document.createElement("li");
            li.innerHTML = `<a>${f.name}</a>`;
            li.querySelector("a").onclick = () => {
              document.getElementById("archivoSeleccionado").value = f.name;
              document.getElementById("archivoSeleccionado").dataset.fileId = f.id;
              window.open(f.webViewLink, "_blank");
            };
            lista.appendChild(li);
          });
        } else {
          lista.innerHTML = "<li>No hay archivos PDF en esta carpeta.</li>";
        }
      });
    }

    // Guardar registro en Google Sheets
    document.getElementById("guardar").addEventListener("click", () => {
      const archivo = document.getElementById("archivoSeleccionado").value;
      const fileId = document.getElementById("archivoSeleccionado").dataset.fileId || "";
      const contraparte = document.getElementById("contraparte").value;
      const categoria = document.getElementById("categoria").value;
      const comentarios = document.getElementById("comentarios").value;

      if (!archivo) {
        alert("Primero selecciona un archivo.");
        return;
      }

      const valores = [
        new Date().toISOString(),
        archivo,
        fileId,
        contraparte,
        categoria,
        comentarios
      ];

      gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: SHEET_ID,
        range: "A:F",
        valueInputOption: "RAW",
        insertDataOption: "INSERT_ROWS",
        resource: { values: [valores] }
      }).then(() => {
        alert("Registro guardado en Sheets!");
        // Limpiar formulario
        document.getElementById("archivoSeleccionado").value = "";
        document.getElementById("contraparte").value = "";
        document.getElementById("categoria").value = "";
        document.getElementById("comentarios").value = "";
      });
    });
  </script>
</body>
</html>

